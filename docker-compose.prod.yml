# Kairos - Production-like Docker Compose
# Use for local testing of production image

version: "3.8"

x-frappe-common: &frappe-common
  image: kairos:latest
  build:
    context: .
    dockerfile: Dockerfile
    args:
      FRAPPE_VERSION: v15
  depends_on:
    mariadb:
      condition: service_healthy
    redis-cache:
      condition: service_started
    redis-queue:
      condition: service_started
  volumes:
    - sites:/home/frappe/frappe-bench/sites
    - logs:/home/frappe/frappe-bench/logs
    - apps:/home/frappe/frappe-bench/apps
  environment:
    - DB_HOST=mariadb
    - DB_PORT=3306
    - REDIS_CACHE=redis://redis-cache:6379
    - REDIS_QUEUE=redis://redis-queue:6379
    - REDIS_SOCKETIO=redis://redis-cache:6379
    - SOCKETIO_PORT=9000

services:
  # ===================
  # Database & Cache
  # ===================
  mariadb:
    image: mariadb:10.6
    container_name: kairos-mariadb
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
      - --innodb-buffer-pool-size=256M
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-kairos_root_password}
    volumes:
      - mariadb-data:/var/lib/mysql
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis-cache:
    image: redis:7-alpine
    container_name: kairos-redis-cache
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru --save "" --appendonly no
    restart: unless-stopped

  redis-queue:
    image: redis:7-alpine
    container_name: kairos-redis-queue
    command: redis-server --maxmemory 256mb --save "" --appendonly yes
    restart: unless-stopped

  # ===================
  # Nginx (Frontend)
  # ===================
  nginx:
    image: nginx:alpine
    container_name: kairos-nginx
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - sites:/home/frappe/frappe-bench/sites:ro
      - apps:/home/frappe/frappe-bench/apps:ro
    ports:
      - "80:80"
    depends_on:
      - web
      - socketio
    restart: unless-stopped

  # ===================
  # Frappe Services
  # ===================
  web:
    <<: *frappe-common
    container_name: kairos-web
    command: >
      gunicorn
        --bind=0.0.0.0:8000
        --workers=${GUNICORN_WORKERS:-4}
        --threads=${GUNICORN_THREADS:-4}
        --worker-class=gthread
        --timeout=120
        --graceful-timeout=30
        --keep-alive=5
        --max-requests=5000
        --max-requests-jitter=500
        --preload
        frappe.app:application
    working_dir: /home/frappe/frappe-bench/sites
    expose:
      - "8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/method/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  socketio:
    <<: *frappe-common
    container_name: kairos-socketio
    command: node /home/frappe/frappe-bench/apps/frappe/socketio.js
    expose:
      - "9000"
    restart: unless-stopped

  worker-default:
    <<: *frappe-common
    container_name: kairos-worker-default
    command: bench worker --queue default
    working_dir: /home/frappe/frappe-bench
    restart: unless-stopped

  worker-short:
    <<: *frappe-common
    container_name: kairos-worker-short
    command: bench worker --queue short
    working_dir: /home/frappe/frappe-bench
    restart: unless-stopped

  worker-long:
    <<: *frappe-common
    container_name: kairos-worker-long
    command: bench worker --queue long
    working_dir: /home/frappe/frappe-bench
    restart: unless-stopped

  scheduler:
    <<: *frappe-common
    container_name: kairos-scheduler
    command: bench schedule
    working_dir: /home/frappe/frappe-bench
    restart: unless-stopped

  # ===================
  # Site Setup (one-time)
  # ===================
  create-site:
    <<: *frappe-common
    container_name: kairos-create-site
    command:
      - bash
      - -c
      - |
        cd /home/frappe/frappe-bench
        SITE_NAME=$${SITE_NAME:-kairos.localhost}

        # Configure common_site_config.json with DB and Redis settings
        cat > sites/common_site_config.json << 'SITECONFIG'
        {
          "db_host": "mariadb",
          "db_port": 3306,
          "redis_cache": "redis://redis-cache:6379",
          "redis_queue": "redis://redis-queue:6379",
          "redis_socketio": "redis://redis-cache:6379",
          "socketio_port": 9000
        }
        SITECONFIG

        if [ ! -d "sites/$$SITE_NAME" ]; then
          echo "Creating site $$SITE_NAME..."
          bench new-site $$SITE_NAME \
            --db-root-password $${DB_ROOT_PASSWORD:-kairos_root_password} \
            --admin-password $${ADMIN_PASSWORD:-admin} \
            --mariadb-user-host-login-scope='%'
          bench --site $$SITE_NAME install-app kairos
          bench use $$SITE_NAME
          echo "Site created successfully!"
        else
          echo "Site already exists, running migrations..."
          bench --site $$SITE_NAME migrate
        fi
    restart: "no"
    profiles:
      - setup

volumes:
  sites:
  logs:
  apps:
  mariadb-data:

networks:
  default:
    name: kairos-network
