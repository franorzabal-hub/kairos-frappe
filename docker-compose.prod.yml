# Kairos - Production-like Docker Compose
# Use for local testing of production image

version: "3.8"

x-frappe-common: &frappe-common
  image: kairos:latest
  build:
    context: .
    dockerfile: Dockerfile
    args:
      FRAPPE_VERSION: v15
  depends_on:
    mariadb:
      condition: service_healthy
    redis-cache:
      condition: service_started
    redis-queue:
      condition: service_started
  volumes:
    - sites:/home/frappe/frappe-bench/sites
    - logs:/home/frappe/frappe-bench/logs
  environment:
    - DB_HOST=mariadb
    - DB_PORT=3306
    - REDIS_CACHE=redis://redis-cache:6379
    - REDIS_QUEUE=redis://redis-queue:6379
    - REDIS_SOCKETIO=redis://redis-cache:6379
    - SOCKETIO_PORT=9000

services:
  # ===================
  # Database & Cache
  # ===================
  mariadb:
    image: mariadb:10.6
    container_name: kairos-mariadb
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
      - --innodb-buffer-pool-size=256M
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-kairos_root_password}
    volumes:
      - mariadb-data:/var/lib/mysql
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis-cache:
    image: redis:7-alpine
    container_name: kairos-redis-cache
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru --save "" --appendonly no
    restart: unless-stopped

  redis-queue:
    image: redis:7-alpine
    container_name: kairos-redis-queue
    command: redis-server --maxmemory 256mb --save "" --appendonly yes
    restart: unless-stopped

  # ===================
  # Frappe Services
  # ===================
  web:
    <<: *frappe-common
    container_name: kairos-web
    command: >
      gunicorn
        --bind=0.0.0.0:8000
        --workers=${GUNICORN_WORKERS:-4}
        --threads=${GUNICORN_THREADS:-4}
        --worker-class=gthread
        --timeout=120
        --graceful-timeout=30
        --keep-alive=5
        --max-requests=5000
        --max-requests-jitter=500
        --preload
        frappe.app:application
    working_dir: /home/frappe/frappe-bench/sites
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/method/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  socketio:
    <<: *frappe-common
    container_name: kairos-socketio
    command: node /home/frappe/frappe-bench/apps/frappe/socketio.js
    ports:
      - "9000:9000"
    restart: unless-stopped

  worker-default:
    <<: *frappe-common
    container_name: kairos-worker-default
    command: bench worker --queue default
    working_dir: /home/frappe/frappe-bench
    restart: unless-stopped

  worker-short:
    <<: *frappe-common
    container_name: kairos-worker-short
    command: bench worker --queue short
    working_dir: /home/frappe/frappe-bench
    restart: unless-stopped

  worker-long:
    <<: *frappe-common
    container_name: kairos-worker-long
    command: bench worker --queue long
    working_dir: /home/frappe/frappe-bench
    restart: unless-stopped

  scheduler:
    <<: *frappe-common
    container_name: kairos-scheduler
    command: bench schedule
    working_dir: /home/frappe/frappe-bench
    restart: unless-stopped

  # ===================
  # Site Setup (one-time)
  # ===================
  create-site:
    <<: *frappe-common
    container_name: kairos-create-site
    command: >
      bash -c "
        cd /home/frappe/frappe-bench &&
        if [ ! -d sites/${SITE_NAME:-kairos.localhost} ]; then
          echo 'Creating site...' &&
          bench new-site ${SITE_NAME:-kairos.localhost}
            --db-root-password ${DB_ROOT_PASSWORD:-kairos_root_password}
            --admin-password ${ADMIN_PASSWORD:-admin}
            --no-mariadb-socket &&
          bench --site ${SITE_NAME:-kairos.localhost} install-app kairos &&
          bench use ${SITE_NAME:-kairos.localhost} &&
          echo 'Site created successfully!'
        else
          echo 'Site already exists, running migrations...' &&
          bench --site ${SITE_NAME:-kairos.localhost} migrate
        fi
      "
    restart: "no"
    profiles:
      - setup

volumes:
  sites:
  logs:
  mariadb-data:

networks:
  default:
    name: kairos-network
