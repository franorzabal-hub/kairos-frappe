apiVersion: batch/v1
kind: Job
metadata:
  name: frappe-create-site
  namespace: kairos
  labels:
    app.kubernetes.io/name: kairos
    app.kubernetes.io/component: setup
spec:
  ttlSecondsAfterFinished: 3600  # Clean up after 1 hour
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kairos
        app.kubernetes.io/component: setup
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000

      initContainers:
        - name: wait-for-db
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z mariadb 3306; do echo "Waiting for MariaDB..."; sleep 5; done; sleep 10']
        - name: wait-for-redis
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z redis-cache 6379; do echo "Waiting for Redis..."; sleep 2; done']
        - name: init-sites
          image: frappe/frappe:v15
          command: ['sh', '-c']
          args:
            - |
              # Copy essential files from image to PVC if not present
              if [ ! -f /mnt/sites/apps.txt ]; then
                echo "Initializing sites directory..."
                cp /home/frappe/frappe-bench/sites/apps.txt /mnt/sites/
                cp -r /home/frappe/frappe-bench/sites/assets /mnt/sites/
                echo "Sites directory initialized"
              fi
              # Always update common_site_config.json from configmap
              cp /config/common_site_config.json /mnt/sites/common_site_config.json
              echo "Config updated"
          volumeMounts:
            - name: sites
              mountPath: /mnt/sites
            - name: config
              mountPath: /config

      containers:
        - name: create-site
          image: frappe/frappe:v15
          imagePullPolicy: IfNotPresent
          command: ['sh', '-c']
          args:
            - |
              set -e
              cd /home/frappe/frappe-bench

              # Check if site already exists
              if [ -d "sites/${SITE_NAME}" ]; then
                echo "Site ${SITE_NAME} already exists. Running migrations..."
                bench --site ${SITE_NAME} migrate
              else
                echo "Creating site ${SITE_NAME}..."

                # Create the site
                bench new-site ${SITE_NAME} \
                  --db-root-password ${DB_ROOT_PASSWORD} \
                  --admin-password ${ADMIN_PASSWORD} \
                  --no-mariadb-socket

                # Install kairos app
                bench --site ${SITE_NAME} install-app kairos

                echo "Site ${SITE_NAME} created successfully!"
              fi

              # Set as default site
              bench use ${SITE_NAME}

              echo "Setup complete!"
          env:
            - name: SITE_NAME
              value: "kairos.localhost"  # Change to your site name
            - name: DB_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: frappe-secrets
                  key: DB_ROOT_PASSWORD
            - name: ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: frappe-secrets
                  key: ADMIN_PASSWORD
          envFrom:
            - configMapRef:
                name: frappe-config
          volumeMounts:
            - name: sites
              mountPath: /home/frappe/frappe-bench/sites
            - name: logs
              mountPath: /home/frappe/frappe-bench/logs

      volumes:
        - name: sites
          persistentVolumeClaim:
            claimName: frappe-sites
        - name: logs
          persistentVolumeClaim:
            claimName: frappe-logs
        - name: config
          configMap:
            name: frappe-config

---
# CronJob for scheduled backups
apiVersion: batch/v1
kind: CronJob
metadata:
  name: frappe-backup
  namespace: kairos
  labels:
    app.kubernetes.io/name: kairos
    app.kubernetes.io/component: backup
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: kairos
            app.kubernetes.io/component: backup
        spec:
          restartPolicy: OnFailure
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
          containers:
            - name: backup
              image: frappe/frappe:v15
              imagePullPolicy: IfNotPresent
              command: ['bench', '--site', 'all', 'backup', '--with-files']
              workingDir: /home/frappe/frappe-bench
              envFrom:
                - configMapRef:
                    name: frappe-config
              volumeMounts:
                - name: sites
                  mountPath: /home/frappe/frappe-bench/sites
                - name: logs
                  mountPath: /home/frappe/frappe-bench/logs
              resources:
                requests:
                  cpu: "100m"
                  memory: "256Mi"
                limits:
                  cpu: "500m"
                  memory: "1Gi"
          volumes:
            - name: sites
              persistentVolumeClaim:
                claimName: frappe-sites
            - name: logs
              persistentVolumeClaim:
                claimName: frappe-logs
