apiVersion: apps/v1
kind: Deployment
metadata:
  name: mariadb
  namespace: kairos
  labels:
    app.kubernetes.io/name: kairos
    app.kubernetes.io/component: database
spec:
  replicas: 1
  strategy:
    type: Recreate  # Required for persistent storage
  selector:
    matchLabels:
      app.kubernetes.io/name: kairos
      app.kubernetes.io/component: database
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kairos
        app.kubernetes.io/component: database
    spec:
      containers:
        - name: mariadb
          image: mariadb:10.6
          imagePullPolicy: IfNotPresent
          ports:
            - name: mysql
              containerPort: 3306
              protocol: TCP
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mariadb-secrets
                  key: MYSQL_ROOT_PASSWORD
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: mariadb-secrets
                  key: MYSQL_USER
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mariadb-secrets
                  key: MYSQL_PASSWORD
          args:
            - --character-set-server=utf8mb4
            - --collation-server=utf8mb4_unicode_ci
            - --skip-character-set-client-handshake
            - --innodb-buffer-pool-size=256M
            - --innodb-log-file-size=64M
            - --innodb-flush-log-at-trx-commit=2
            - --max-connections=200
            - --wait-timeout=28800
            - --interactive-timeout=28800
          volumeMounts:
            - name: data
              mountPath: /var/lib/mysql
            - name: initdb
              mountPath: /docker-entrypoint-initdb.d
          resources:
            requests:
              cpu: "250m"
              memory: "512Mi"
            limits:
              cpu: "1000m"
              memory: "2Gi"
          livenessProbe:
            exec:
              command:
                - mysqladmin
                - ping
                - -h
                - localhost
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
          readinessProbe:
            exec:
              command:
                - mysqladmin
                - ping
                - -h
                - localhost
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3

      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: mariadb-data
        - name: initdb
          configMap:
            name: mariadb-initdb

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mariadb-initdb
  namespace: kairos
  labels:
    app.kubernetes.io/name: kairos
    app.kubernetes.io/component: database
data:
  init.sql: |
    -- Create default database for Frappe
    -- Sites will create their own databases
    SET GLOBAL character_set_server = 'utf8mb4';
    SET GLOBAL collation_server = 'utf8mb4_unicode_ci';
